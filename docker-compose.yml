services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${APP_PORT:-3000}:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: ${DATABASE_URL:-file:/data/sqlite.db}
      DATABASE_PATH: ${DATABASE_PATH:-/data/sqlite.db}
      CACHE_DATABASE_PATH: ${CACHE_DATABASE_PATH:-/data/cache.db}
      SESSION_SECRET: ${SESSION_SECRET:-changeme-session-secret}
      INTERNAL_COMMAND_TOKEN: ${INTERNAL_COMMAND_TOKEN:-changeme-internal-token}
      HONEYPOT_SECRET: ${HONEYPOT_SECRET:-changeme-honeypot}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-minioadmin}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-minioadmin}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_ENDPOINT_URL_S3: http://minio:9000
      BUCKET_NAME: ${BUCKET_NAME:-podcasty}
      LITEFS_DIR: ${LITEFS_DIR:-/data/litefs}
      ENABLE_WHISPER: ${ENABLE_WHISPER:-"true"}
      WHISPER_ENDPOINT: http://whisper:9000/asr
      WHISPER_AUTH_HEADER: ${WHISPER_AUTH_HEADER:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_AUDIO_MODEL: ${OPENAI_AUDIO_MODEL:-whisper-1}
      ALLOW_INDEXING: ${ALLOW_INDEXING:-"false"}
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      RESEND_FROM: ${RESEND_FROM:-}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_FROM: ${SMTP_FROM:-}
      SMTP_SECURE: ${SMTP_SECURE:-true}
    depends_on:
      - minio
      - whisper
    volumes:
      - app-data:/data
      - uploads:/app/uploads
    networks:
      - app-network

  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z-cpuv1
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "19000:9000"
      - "19001:9001"
    volumes:
      - podcasty-data:/data
    networks:
      - app-network
    healthcheck:
      test: [ "CMD", "mc", "ready", "local" ]
      interval: 5s
      timeout: 5s
      retries: 5

  whisper:
    image: onerahmet/openai-whisper-asr-webservice:latest
    environment:
#      - ASR_MODEL=base
      - ASR_MODEL=tiny
      - ASR_ENGINE=openai_whisper
      - ASR_LANGUAGE=en
      - ASR_BEAM_SIZE=2
    ports:
      - "19002:9000"
    volumes:
      - whisper-models:/root/.cache
    networks:
      - app-network
volumes:
  app-data:
  uploads:
  podcasty-data:
  whisper-models:

networks:
  app-network:
    driver: bridge
